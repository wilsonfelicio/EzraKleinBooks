<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ezra Klein Show — Book Recommendations</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@300;400;500;600;700&display=swap');
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Inter', -apple-system, sans-serif; background: #faf9f6; color: #1a1a1a; min-height: 100vh; }

  .header { text-align: center; padding: 80px 20px 48px; border-bottom: 1px solid #e0ddd5; }
  .header h1 { font-family: 'Playfair Display', Georgia, serif; font-size: 2.6rem; font-weight: 700; letter-spacing: -0.02em; margin-bottom: 8px; color: #1a1a1a; }
  .header h1 span { color: #2c3e6b; }
  .header .subtitle { font-family: 'Playfair Display', Georgia, serif; font-size: 1.4rem; font-weight: 600; color: #444; margin-bottom: 12px; }
  .header p { color: #666; font-size: 1rem; max-width: 600px; margin: 0 auto; line-height: 1.7; }

  .stats-bar { display: flex; justify-content: center; gap: 40px; padding: 28px 20px; border-bottom: 1px solid #e0ddd5; }
  .stat { text-align: center; }
  .stat .num { font-size: 2rem; font-weight: 700; color: #2c3e6b; }
  .stat .label { font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 0.08em; margin-top: 4px; }

  .tabs { display: flex; justify-content: center; gap: 0; padding: 0 20px; border-bottom: 1px solid #e0ddd5; position: sticky; top: 0; background: #faf9f6; z-index: 10; flex-wrap: wrap; }
  .tab { padding: 14px 20px; cursor: pointer; font-size: 0.85rem; font-weight: 500; background: transparent; color: #888; border: none; border-bottom: 2px solid transparent; transition: color 0.2s, border-color 0.2s; }
  .tab:hover { color: #1a1a1a; }
  .tab.active { color: #2c3e6b; border-bottom-color: #2c3e6b; }

  .content { max-width: 1200px; margin: 0 auto; padding: 40px 20px 60px; }
  .section { display: none; }
  .section.active { display: block; }

  .chart-title { font-family: 'Playfair Display', Georgia, serif; font-size: 1.3rem; font-weight: 700; margin-bottom: 8px; color: #1a1a1a; }
  .chart-subtitle { font-size: 0.85rem; color: #888; margin-bottom: 24px; }

  /* Genre badges */
  .genre-badge { display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }
  .genre-badge.fiction { background: #f3ebe6; color: #b56b4a; }
  .genre-badge.nonfiction { background: #eaf0ea; color: #5a7a5a; }
  .genre-badge.poetry { background: #f0eddf; color: #9a8445; }
  .genre-badge.other { background: #f0eeeb; color: #888; }

  /* Bar chart */
  .bar-row { display: flex; align-items: center; margin-bottom: 10px; gap: 12px; cursor: pointer; padding: 4px 0; border-radius: 4px; transition: background 0.15s; }
  .bar-row:hover { background: #f5f3ef; }
  .bar-label { flex: 0 0 300px; text-align: right; font-size: 0.85rem; color: #1a1a1a; overflow: hidden; text-overflow: ellipsis; }
  .bar-label .author { color: #888; font-size: 0.76rem; display: block; }
  .bar-container { flex: 1; display: flex; align-items: center; gap: 8px; }
  .bar { height: 28px; border-radius: 3px; transition: width 0.6s ease; min-width: 28px; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; }
  .bar.fiction-bar { background: #b56b4a; }
  .bar.nonfiction-bar { background: #5a7a5a; }
  .bar.poetry-bar { background: #9a8445; }
  .bar .count { font-size: 0.78rem; font-weight: 600; color: #fff; }
  .gr-badge { display: inline-flex; align-items: center; gap: 4px; font-size: 0.72rem; color: #9a8445; background: #f0eddf; padding: 3px 8px; border-radius: 3px; white-space: nowrap; }
  .bar-recommenders { display: none; font-size: 0.78rem; color: #888; margin: -4px 0 8px 312px; padding-left: 12px; }
  .bar-row.expanded + .bar-recommenders { display: block; }

  /* Genre overview */
  .genre-overview { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px; }
  .genre-card { background: #fff; border: 1px solid #e0ddd5; border-radius: 6px; padding: 24px; text-align: center; }
  .genre-card .big-num { font-family: 'Playfair Display', Georgia, serif; font-size: 2.4rem; font-weight: 700; }
  .genre-card .big-num.fiction { color: #b56b4a; }
  .genre-card .big-num.nonfiction { color: #5a7a5a; }
  .genre-card .big-num.poetry { color: #9a8445; }
  .genre-card .genre-label { font-size: 0.85rem; color: #888; margin-top: 4px; }
  .genre-card .genre-pct { font-size: 1.2rem; font-weight: 600; color: #666; margin-top: 2px; }
  .genre-card .avg-rating { font-size: 0.8rem; color: #9a8445; margin-top: 8px; }

  .donut-container { display: flex; justify-content: center; align-items: center; gap: 40px; margin: 24px 0 40px; flex-wrap: wrap; }
  .donut-svg { width: 200px; height: 200px; }
  .donut-legend { font-size: 0.9rem; color: #1a1a1a; }
  .donut-legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
  .donut-legend-color { width: 14px; height: 14px; border-radius: 3px; }

  /* Episode list */
  .episode-card { background: #fff; border: 1px solid #e0ddd5; border-radius: 6px; padding: 24px; margin-bottom: 16px; }
  .episode-date { font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 6px; }
  .episode-title { font-family: 'Playfair Display', Georgia, serif; font-size: 1.1rem; font-weight: 600; margin-bottom: 4px; color: #1a1a1a; }
  .episode-guests { font-size: 0.88rem; color: #2c3e6b; margin-bottom: 16px; }
  .book-list { list-style: none; }
  .book-list li { padding: 8px 0; border-top: 1px solid #e0ddd5; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .book-list li:first-child { border-top: none; }
  .book-num { color: #bbb; font-size: 0.75rem; font-weight: 600; flex-shrink: 0; width: 18px; }
  .book-title-text { font-weight: 500; font-size: 0.92rem; color: #1a1a1a; }
  .book-author-text { color: #888; font-size: 0.84rem; }
  .book-rating { color: #9a8445; font-size: 0.76rem; }

  /* All books table */
  .books-table { width: 100%; border-collapse: collapse; }
  .books-table th { text-align: left; padding: 12px 12px; font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.08em; color: #888; border-bottom: 2px solid #e0ddd5; cursor: pointer; user-select: none; white-space: nowrap; }
  .books-table th:hover { color: #2c3e6b; }
  .books-table th.sorted { color: #2c3e6b; }
  .books-table td { padding: 10px 12px; font-size: 0.85rem; border-bottom: 1px solid #f0eeeb; vertical-align: top; }
  .books-table tr:hover td { background: #f5f3ef; }

  .rec-badge { display: inline-block; background: #e8ecf4; color: #2c3e6b; padding: 2px 8px; border-radius: 3px; font-size: 0.78rem; font-weight: 600; }
  .rec-badge.hot { background: #f3ebe6; color: #b56b4a; }
  .rating-num { color: #9a8445; font-size: 0.85rem; font-weight: 600; }
  .rating-count { color: #888; font-size: 0.7rem; display: block; }

  .search-box { width: 100%; max-width: 400px; padding: 12px 16px; border-radius: 6px; border: 1px solid #e0ddd5; background: #fff; color: #1a1a1a; font-size: 0.92rem; outline: none; font-family: inherit; }
  .search-box:focus { border-color: #2c3e6b; }
  .search-box::placeholder { color: #aaa; }

  .filter-row { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
  .filter-select { padding: 8px 14px; border-radius: 6px; border: 1px solid #e0ddd5; background: #fff; color: #1a1a1a; font-size: 0.85rem; font-family: inherit; cursor: pointer; }

  /* Genre pills filter */
  .genre-pills { display: flex; gap: 6px; flex-wrap: wrap; }
  .genre-pill { padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; font-weight: 500; border: 1px solid #e0ddd5; background: #fff; color: #888; transition: all 0.2s; }
  .genre-pill:hover { border-color: #bbb; }
  .genre-pill.active { border-color: #2c3e6b; color: #2c3e6b; background: #e8ecf4; }
  .genre-pill.active.fiction { border-color: #b56b4a; color: #b56b4a; background: #f3ebe6; }
  .genre-pill.active.nonfiction { border-color: #5a7a5a; color: #5a7a5a; background: #eaf0ea; }
  .genre-pill.active.poetry { border-color: #9a8445; color: #9a8445; background: #f0eddf; }

  .guests-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px; }
  .guest-card { background: #fff; border: 1px solid #e0ddd5; border-radius: 6px; padding: 18px; }
  .guest-name { font-family: 'Playfair Display', Georgia, serif; font-weight: 600; font-size: 1rem; margin-bottom: 4px; color: #1a1a1a; }
  .guest-ep { font-size: 0.8rem; color: #888; margin-bottom: 8px; }
  .guest-books { font-size: 0.82rem; color: #666; line-height: 1.6; }

  .load-more { display: block; margin: 20px auto; padding: 12px 32px; background: #fff; color: #2c3e6b; border: 1px solid #e0ddd5; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-family: inherit; }
  .load-more:hover { background: #f5f3ef; }

  /* Scatter plot */
  .scatter-container { position: relative; width: 100%; height: 500px; background: #fff; border: 1px solid #e0ddd5; border-radius: 6px; margin: 20px 0; overflow: hidden; }
  .scatter-dot { position: absolute; border-radius: 50%; cursor: pointer; transition: transform 0.15s; z-index: 1; }
  .scatter-dot:hover { transform: scale(2); z-index: 5; }
  .scatter-dot.fiction { background: #b56b4a; }
  .scatter-dot.nonfiction { background: #5a7a5a; }
  .scatter-dot.poetry { background: #9a8445; }
  .scatter-axis-x, .scatter-axis-y { position: absolute; color: #888; font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.06em; }
  .scatter-axis-x { bottom: 8px; left: 50%; transform: translateX(-50%); }
  .scatter-axis-y { top: 50%; left: 8px; transform: rotate(-90deg) translateX(-50%); transform-origin: left center; }
  .scatter-tooltip { display: none; position: absolute; background: #fff; border: 1px solid #e0ddd5; border-radius: 6px; padding: 10px 14px; font-size: 0.82rem; z-index: 10; pointer-events: none; max-width: 300px; line-height: 1.4; color: #1a1a1a; }
  .scatter-labels { position: absolute; color: #aaa; font-size: 0.7rem; }
  .scatter-legend { position: absolute; top: 12px; right: 16px; font-size: 0.78rem; display: flex; gap: 16px; color: #666; }
  .scatter-legend-item { display: flex; align-items: center; gap: 5px; }
  .scatter-legend-dot { width: 10px; height: 10px; border-radius: 50%; }

  /* Top rated cards */
  .top-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; margin-top: 24px; }
  .top-card { background: #fff; border: 1px solid #e0ddd5; border-radius: 6px; padding: 20px; display: flex; gap: 16px; align-items: flex-start; }
  .top-rank { font-family: 'Playfair Display', Georgia, serif; font-size: 1.6rem; font-weight: 700; color: #ccc; flex-shrink: 0; width: 32px; text-align: center; }
  .top-rank.gold { color: #9a8445; }
  .top-rank.silver { color: #999; }
  .top-rank.bronze { color: #b56b4a; }
  .top-info { flex: 1; }
  .top-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 2px; color: #1a1a1a; }
  .top-author { color: #888; font-size: 0.82rem; margin-bottom: 8px; }
  .top-stats { display: flex; gap: 12px; font-size: 0.8rem; flex-wrap: wrap; }
  .top-stats .rating { color: #9a8445; font-weight: 600; }
  .top-stats .recs { color: #2c3e6b; }
  .top-stats .num-ratings { color: #888; }

  .footer { text-align: center; padding: 40px 20px; color: #aaa; font-size: 0.8rem; border-top: 1px solid #e0ddd5; }
  .footer a { color: #2c3e6b; }

  /* Tablet */
  @media (max-width: 900px) {
    .top-grid { grid-template-columns: 1fr; }
    .guests-grid { grid-template-columns: 1fr; }
    .bar-label { flex: 0 0 200px; }
    .bar-recommenders { margin-left: 212px; }
  }

  /* Mobile */
  @media (max-width: 600px) {
    .header { padding: 48px 16px 32px; }
    .header h1 { font-size: 1.5rem; }
    .header .subtitle { font-size: 1.1rem; }
    .header p { font-size: 0.88rem; }

    .stats-bar { gap: 12px; padding: 20px 16px; display: grid; grid-template-columns: repeat(3, 1fr); }
    .stat .num { font-size: 1.3rem; }
    .stat .label { font-size: 0.65rem; }

    .tabs { overflow-x: auto; justify-content: flex-start; -webkit-overflow-scrolling: touch; scrollbar-width: none; padding: 0 8px; }
    .tabs::-webkit-scrollbar { display: none; }
    .tab { padding: 12px 14px; font-size: 0.78rem; white-space: nowrap; flex-shrink: 0; }

    .content { padding: 24px 12px 40px; }

    .chart-title { font-size: 1.1rem; }

    /* Bar charts: stack label above bar */
    .bar-row { flex-direction: column; align-items: flex-start; gap: 4px; padding: 8px 0; }
    .bar-label { flex: none; width: 100%; text-align: left; font-size: 0.82rem; }
    .bar-label .author { display: inline; }
    .bar-label .author::before { content: ' — '; }
    .bar-container { width: 100%; }
    .bar-recommenders { margin-left: 0; padding-left: 0; margin-top: 2px; }

    /* Donut */
    .donut-container { flex-direction: column; gap: 16px; }
    .donut-svg { width: 160px; height: 160px; }

    /* Genre overview */
    .genre-overview { grid-template-columns: 1fr; gap: 10px; }
    .genre-card { padding: 16px; display: flex; align-items: center; gap: 16px; text-align: left; }
    .genre-card .big-num { font-size: 1.8rem; flex-shrink: 0; min-width: 48px; }
    .genre-card .genre-label { margin-top: 0; }
    .genre-card .genre-pct { font-size: 1rem; margin-top: 0; }
    .genre-card .avg-rating { margin-top: 2px; }

    /* Episode cards */
    .episode-card { padding: 16px; margin-bottom: 12px; }
    .episode-title { font-size: 1rem; }
    .book-list li { font-size: 0.84rem; }

    /* All books table — horizontal scroll */
    .books-table { display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; font-size: 0.78rem; }
    .books-table th, .books-table td { padding: 8px 10px; min-width: 80px; }
    .books-table th:first-child, .books-table td:first-child { min-width: 160px; }

    /* Top rated */
    .top-grid { grid-template-columns: 1fr; gap: 10px; }
    .top-card { padding: 16px; }

    /* Guests */
    .guests-grid { grid-template-columns: 1fr; gap: 10px; }
    .guest-card { padding: 14px; }

    /* Scatter */
    .scatter-container { height: 300px; border-radius: 4px; }
    .scatter-legend { top: 8px; right: 8px; font-size: 0.68rem; gap: 8px; }

    /* Filters */
    .filter-row { flex-direction: column; align-items: stretch; gap: 10px; }
    .search-box { max-width: 100%; }
    .filter-select { width: 100%; }
    .genre-pills { gap: 4px; }
    .genre-pill { padding: 5px 10px; font-size: 0.75rem; }

    /* Load more */
    .load-more { width: 100%; padding: 14px; }

    .footer { padding: 24px 16px; font-size: 0.75rem; }
  }
</style>
</head>
<body>

<div class="header">
  <h1>The <span>Ezra Klein</span> Show</h1>
  <div class="subtitle">Book Recommendations</div>
  <p>Every episode ends with the question: <em>"What are three books you'd recommend to the audience?"</em> Here are five years of answers, classified by genre and cross-referenced with Goodreads.</p>
</div>

<div class="stats-bar">
  <div class="stat"><div class="num" id="s-ep">0</div><div class="label">Episodes</div></div>
  <div class="stat"><div class="num" id="s-books">0</div><div class="label">Unique Books</div></div>
  <div class="stat"><div class="num" id="s-nf">0</div><div class="label">Nonfiction</div></div>
  <div class="stat"><div class="num" id="s-fic">0</div><div class="label">Fiction</div></div>
  <div class="stat"><div class="num" id="s-po">0</div><div class="label">Poetry</div></div>
  <div class="stat"><div class="num" id="s-guests">0</div><div class="label">Guests</div></div>
</div>

<div class="tabs">
  <div class="tab active" data-tab="genre">Genre Overview</div>
  <div class="tab" data-tab="chart">Most Recommended</div>
  <div class="tab" data-tab="toprated">Highest Rated</div>
  <div class="tab" data-tab="scatter">Ratings vs Recs</div>
  <div class="tab" data-tab="episodes">By Episode</div>
  <div class="tab" data-tab="allbooks">All Books</div>
  <div class="tab" data-tab="guests">By Guest</div>
</div>

<div class="content">

  <!-- GENRE OVERVIEW -->
  <div class="section active" id="section-genre">
    <p class="chart-title">Genre Breakdown</p>
    <p class="chart-subtitle">How fiction, nonfiction, and poetry split across all recommendations</p>
    <div class="donut-container">
      <svg class="donut-svg" viewBox="0 0 42 42" id="donut"></svg>
      <div class="donut-legend" id="donut-legend"></div>
    </div>
    <div class="genre-overview" id="genre-overview"></div>
    <p class="chart-title" style="margin-top:40px;">Top Fiction</p>
    <p class="chart-subtitle">Most recommended fiction titles</p>
    <div id="top-fiction"></div>
    <p class="chart-title" style="margin-top:40px;">Top Nonfiction</p>
    <p class="chart-subtitle">Most recommended nonfiction titles</p>
    <div id="top-nonfiction"></div>
  </div>

  <!-- CHART -->
  <div class="section" id="section-chart">
    <p class="chart-title">Books Recommended by Multiple Guests</p>
    <div class="filter-row">
      <div class="genre-pills" id="chart-genre-pills"></div>
    </div>
    <div id="chart"></div>
  </div>

  <!-- TOP RATED -->
  <div class="section" id="section-toprated">
    <p class="chart-title">Highest-Rated on Goodreads</p>
    <p class="chart-subtitle">Min. 500 Goodreads ratings</p>
    <div class="filter-row">
      <select class="filter-select" id="toprated-sort">
        <option value="rating">By Rating</option>
        <option value="popularity">By # Ratings</option>
        <option value="combined">Rating x Recs</option>
      </select>
      <div class="genre-pills" id="toprated-genre-pills"></div>
    </div>
    <div class="top-grid" id="toprated-grid"></div>
  </div>

  <!-- SCATTER -->
  <div class="section" id="section-scatter">
    <p class="chart-title">Goodreads Rating vs. Times Recommended</p>
    <p class="chart-subtitle">Each dot is a book, colored by genre. Hover for details.</p>
    <div class="scatter-container" id="scatter">
      <div class="scatter-axis-x">Times Recommended</div>
      <div class="scatter-axis-y">Goodreads Rating</div>
      <div class="scatter-legend">
        <div class="scatter-legend-item"><div class="scatter-legend-dot" style="background:#5a7a5a;"></div> Nonfiction</div>
        <div class="scatter-legend-item"><div class="scatter-legend-dot" style="background:#b56b4a;"></div> Fiction</div>
        <div class="scatter-legend-item"><div class="scatter-legend-dot" style="background:#9a8445;"></div> Poetry</div>
      </div>
      <div class="scatter-tooltip" id="scatter-tooltip"></div>
    </div>
  </div>

  <!-- EPISODES -->
  <div class="section" id="section-episodes">
    <div class="filter-row">
      <input type="text" class="search-box" id="ep-search" placeholder="Search episodes, guests, or books...">
      <select class="filter-select" id="ep-year"><option value="">All Years</option><option value="2026">2026</option><option value="2025">2025</option><option value="2024">2024</option><option value="2023">2023</option><option value="2022">2022</option><option value="2021">2021</option></select>
    </div>
    <div id="episodes-list"></div>
    <button class="load-more" id="ep-load-more">Load More Episodes</button>
  </div>

  <!-- ALL BOOKS -->
  <div class="section" id="section-allbooks">
    <div class="filter-row">
      <input type="text" class="search-box" id="book-search" placeholder="Search book title or author...">
      <select class="filter-select" id="book-sort">
        <option value="count-desc">Most Recommended</option>
        <option value="rating-desc">Highest Rated</option>
        <option value="rating-asc">Lowest Rated</option>
        <option value="title-asc">Title A-Z</option>
        <option value="popularity-desc">Most Popular</option>
      </select>
      <div class="genre-pills" id="books-genre-pills"></div>
    </div>
    <table class="books-table">
      <thead><tr><th data-sort="title">Book</th><th data-sort="author">Author</th><th>Genre</th><th>Recommended By</th><th data-sort="count">Recs</th><th data-sort="rating">Rating</th></tr></thead>
      <tbody id="books-tbody"></tbody>
    </table>
    <button class="load-more" id="book-load-more">Load More</button>
  </div>

  <!-- GUESTS -->
  <div class="section" id="section-guests">
    <input type="text" class="search-box" id="guest-search" placeholder="Search guest name..." style="margin-bottom:24px;">
    <div class="guests-grid" id="guests-grid"></div>
  </div>

</div>

<div class="footer">Data: Jan 2021 – Feb 2026 | Sources: <a href="https://www.ezrasbookshelf.com/">ezrasbookshelf.com</a>, <a href="https://www.ezrakleinbooks.com/">ezrakleinbooks.com</a>, <a href="https://www.goodreads.com/">Goodreads</a></div>

<script>
const COLORS = { fiction: '#b56b4a', nonfiction: '#5a7a5a', poetry: '#9a8445', other: '#888' };

fetch('books_complete.json').then(r => r.json()).then(data => {
  const episodes = data.episodes;
  const topBooks = data.top_books;
  const allBooksData = data.all_books;
  const gc = data.metadata.genre_counts;

  // Stats
  document.getElementById('s-ep').textContent = data.metadata.total_episodes;
  document.getElementById('s-books').textContent = data.metadata.total_unique_books;
  document.getElementById('s-guests').textContent = data.metadata.total_unique_guests;
  document.getElementById('s-nf').textContent = gc.nonfiction;
  document.getElementById('s-fic').textContent = gc.fiction;
  document.getElementById('s-po').textContent = gc.poetry;

  const ratedBooks = allBooksData.filter(b => b.rating);

  // ========= GENRE OVERVIEW =========
  const total = gc.fiction + gc.nonfiction + gc.poetry + (gc.other || 0);
  const genres = [
    { key: 'nonfiction', label: 'Nonfiction', count: gc.nonfiction, color: COLORS.nonfiction },
    { key: 'fiction', label: 'Fiction', count: gc.fiction, color: COLORS.fiction },
    { key: 'poetry', label: 'Poetry', count: gc.poetry, color: COLORS.poetry },
  ];

  // Donut chart
  const svg = document.getElementById('donut');
  let offset = 0;
  genres.forEach(g => {
    const pct = g.count / total * 100;
    const dashArray = `${pct} ${100 - pct}`;
    svg.innerHTML += `<circle cx="21" cy="21" r="15.9" fill="none" stroke="${g.color}" stroke-width="4" stroke-dasharray="${dashArray}" stroke-dashoffset="${-offset}" transform="rotate(-90 21 21)"/>`;
    offset += pct;
  });
  svg.innerHTML += `<text x="21" y="20" text-anchor="middle" fill="#1a1a1a" font-size="4" font-weight="700">${total}</text><text x="21" y="24" text-anchor="middle" fill="#888" font-size="2.2">books</text>`;

  const legendEl = document.getElementById('donut-legend');
  genres.forEach(g => {
    legendEl.innerHTML += `<div class="donut-legend-item"><div class="donut-legend-color" style="background:${g.color}"></div><span>${g.label}: ${g.count} (${(g.count/total*100).toFixed(0)}%)</span></div>`;
  });

  // Genre cards with avg rating
  const overviewEl = document.getElementById('genre-overview');
  genres.forEach(g => {
    const genreRated = ratedBooks.filter(b => b.genre === g.key);
    const avgRating = genreRated.length > 0 ? (genreRated.reduce((s, b) => s + b.rating, 0) / genreRated.length).toFixed(2) : '—';
    overviewEl.innerHTML += `<div class="genre-card"><div class="big-num ${g.key}">${g.count}</div><div class="genre-label">${g.label}</div><div class="genre-pct">${(g.count/total*100).toFixed(0)}%</div><div class="avg-rating">Avg Goodreads: ★ ${avgRating}</div></div>`;
  });

  // Top fiction/nonfiction bars
  function renderGenreBars(containerId, genre, limit) {
    const el = document.getElementById(containerId);
    const books = allBooksData.filter(b => b.genre === genre && b.count >= 2).sort((a, b) => b.count - a.count);
    const max = books.length > 0 ? books[0].count : 1;
    books.slice(0, limit).forEach(b => {
      const pct = (b.count / max) * 100;
      const rHtml = b.rating ? `<span class="gr-badge">★ ${b.rating}</span>` : '';
      el.innerHTML += `<div class="bar-row" onclick="this.classList.toggle('expanded')"><div class="bar-label">${esc(b.title)}<span class="author">${esc(b.author)}</span></div><div class="bar-container"><div class="bar ${genre}-bar" style="width:${Math.max(pct,8)}%"><span class="count">${b.count}</span></div>${rHtml}</div></div><div class="bar-recommenders">By: ${esc(b.recommended_by.join(', '))}</div>`;
    });
    if (books.length === 0) el.innerHTML = '<p style="color:#aaa;">No books with 2+ recommendations in this genre.</p>';
  }
  renderGenreBars('top-fiction', 'fiction', 20);
  renderGenreBars('top-nonfiction', 'nonfiction', 20);

  // ========= MOST RECOMMENDED (with genre filter) =========
  let chartGenreFilter = 'all';

  function createGenrePills(containerId, onChange) {
    const el = document.getElementById(containerId);
    el.innerHTML = `<div class="genre-pill active" data-g="all">All</div><div class="genre-pill" data-g="nonfiction">Nonfiction</div><div class="genre-pill" data-g="fiction">Fiction</div><div class="genre-pill" data-g="poetry">Poetry</div>`;
    el.querySelectorAll('.genre-pill').forEach(pill => {
      pill.addEventListener('click', () => {
        el.querySelectorAll('.genre-pill').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        if (pill.dataset.g !== 'all') pill.classList.add(pill.dataset.g);
        onChange(pill.dataset.g);
      });
    });
  }

  function renderChart(genreFilter) {
    const el = document.getElementById('chart');
    el.innerHTML = '';
    let books = topBooks;
    if (genreFilter !== 'all') books = books.filter(b => b.genre === genreFilter);
    const max = books.length > 0 ? books[0].count : 1;
    books.forEach(b => {
      const pct = (b.count / max) * 100;
      const rHtml = b.rating ? `<span class="gr-badge">★ ${b.rating}</span>` : '';
      const genre = b.genre || 'nonfiction';
      el.innerHTML += `<div class="bar-row" onclick="this.classList.toggle('expanded')"><div class="bar-label">${esc(b.title)}<span class="author">${esc(b.author)}</span></div><div class="bar-container"><div class="bar ${genre}-bar" style="width:${Math.max(pct,8)}%"><span class="count">${b.count}</span></div>${rHtml}<span class="genre-badge ${genre}">${genre}</span></div></div><div class="bar-recommenders">By: ${esc(b.recommended_by.join(', '))}</div>`;
    });
    if (books.length === 0) el.innerHTML = '<p style="color:#aaa;">No multi-recommended books in this genre.</p>';
  }

  createGenrePills('chart-genre-pills', g => renderChart(g));
  renderChart('all');

  // ========= TOP RATED =========
  let topratedGenre = 'all';
  function renderTopRated(sortBy, genre) {
    const el = document.getElementById('toprated-grid');
    let books = ratedBooks.filter(b => b.num_ratings >= 500);
    if (genre !== 'all') books = books.filter(b => b.genre === genre);
    if (sortBy === 'rating') books.sort((a, b) => b.rating - a.rating);
    else if (sortBy === 'popularity') books.sort((a, b) => (b.num_ratings||0) - (a.num_ratings||0));
    else books.sort((a, b) => (b.rating * b.count) - (a.rating * a.count));
    let html = '';
    books.slice(0, 50).forEach((b, i) => {
      const rc = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
      html += `<div class="top-card"><div class="top-rank ${rc}">${i+1}</div><div class="top-info"><div class="top-title">${esc(b.title)}</div><div class="top-author">${esc(b.author)}</div><div class="top-stats"><span class="rating">★ ${b.rating}</span><span class="genre-badge ${b.genre}">${b.genre}</span><span class="recs">${b.count}x rec'd</span><span class="num-ratings">${fmtNum(b.num_ratings)} ratings</span></div></div></div>`;
    });
    el.innerHTML = html;
  }
  createGenrePills('toprated-genre-pills', g => { topratedGenre = g; renderTopRated(document.getElementById('toprated-sort').value, g); });
  renderTopRated('rating', 'all');
  document.getElementById('toprated-sort').addEventListener('change', e => renderTopRated(e.target.value, topratedGenre));

  // ========= SCATTER =========
  let scatterDone = false;
  function renderScatter() {
    const el = document.getElementById('scatter');
    const tooltip = document.getElementById('scatter-tooltip');
    el.querySelectorAll('.scatter-dot, .scatter-labels').forEach(e => e.remove());
    const rect = el.getBoundingClientRect();
    const PAD = 60;
    const W = rect.width - PAD * 2;
    const H = rect.height - PAD * 2;
    const maxRecs = Math.max(...ratedBooks.map(b => b.count));
    const minR = Math.min(...ratedBooks.map(b => b.rating));
    const maxR = Math.max(...ratedBooks.map(b => b.rating));
    const rRange = maxR - minR || 1;

    for (let r = Math.ceil(minR*10)/10; r <= maxR; r += 0.2) {
      const y = PAD + H - ((r - minR) / rRange) * H;
      const l = document.createElement('div'); l.className = 'scatter-labels';
      l.style.cssText = `left:${PAD-30}px;top:${y-6}px;`; l.textContent = r.toFixed(1); el.appendChild(l);
    }
    for (let c = 1; c <= maxRecs; c++) {
      const x = PAD + ((c-1)/(maxRecs-1||1)) * W;
      const l = document.createElement('div'); l.className = 'scatter-labels';
      l.style.cssText = `left:${x-4}px;bottom:${PAD-20}px;`; l.textContent = c; el.appendChild(l);
    }

    ratedBooks.forEach(b => {
      const x = PAD + ((b.count-1)/(maxRecs-1||1)) * W;
      const y = PAD + H - ((b.rating - minR) / rRange) * H;
      const dot = document.createElement('div');
      const genre = b.genre || 'nonfiction';
      dot.className = 'scatter-dot ' + genre;
      const sz = Math.max(6, Math.min(16, 4 + b.count * 3));
      dot.style.cssText = `left:${x-sz/2}px;top:${y-sz/2}px;width:${sz}px;height:${sz}px;`;
      dot.addEventListener('mouseenter', e => {
        tooltip.innerHTML = `<strong>${esc(b.title)}</strong><br><span style="color:#888;">${esc(b.author)}</span><br><span style="color:${COLORS[genre]};">${genre}</span> · <span style="color:#9a8445;">★ ${b.rating}</span> (${fmtNum(b.num_ratings)})<br><span style="color:#2c3e6b;">${b.count}x: ${esc(b.recommended_by.join(', '))}</span>`;
        tooltip.style.display = 'block';
        const tx = e.clientX - el.getBoundingClientRect().left + 15;
        const ty = e.clientY - el.getBoundingClientRect().top - 10;
        tooltip.style.left = Math.min(tx, rect.width - 320) + 'px';
        tooltip.style.top = ty + 'px';
      });
      dot.addEventListener('mouseleave', () => tooltip.style.display = 'none');
      el.appendChild(dot);
    });
  }

  // ========= EPISODES =========
  let epPage = 1;
  function renderEpisodes() {
    const el = document.getElementById('episodes-list');
    const f = document.getElementById('ep-search').value.toLowerCase();
    const y = document.getElementById('ep-year').value;
    let filtered = episodes;
    if (y) filtered = filtered.filter(ep => ep.date.startsWith(y));
    if (f) filtered = filtered.filter(ep => (ep.title + ' ' + ep.guests + ' ' + ep.books.map(b => b.title + ' ' + b.author).join(' ')).toLowerCase().includes(f));
    const toShow = filtered.slice(0, epPage * 30);
    let html = '';
    toShow.forEach(ep => {
      html += `<div class="episode-card"><div class="episode-date">${fmtDate(ep.date)}</div><div class="episode-title">${esc(ep.title)}</div><div class="episode-guests">${esc(ep.guests)}</div><ol class="book-list">${ep.books.map((b, i) => {
        const genre = b.genre || 'nonfiction';
        const rHtml = b.rating ? `<span class="book-rating">★ ${b.rating}</span>` : '';
        return `<li><span class="book-num">${i+1}.</span><span class="book-title-text">${esc(b.title)}</span> <span class="book-author-text">— ${esc(b.author)}</span> <span class="genre-badge ${genre}">${genre}</span> ${rHtml}</li>`;
      }).join('')}</ol></div>`;
    });
    el.innerHTML = html || '<p style="color:#aaa;">No episodes match.</p>';
    document.getElementById('ep-load-more').style.display = toShow.length < filtered.length ? 'block' : 'none';
  }
  renderEpisodes();
  document.getElementById('ep-search').addEventListener('input', () => { epPage = 1; renderEpisodes(); });
  document.getElementById('ep-year').addEventListener('change', () => { epPage = 1; renderEpisodes(); });
  document.getElementById('ep-load-more').addEventListener('click', () => { epPage++; renderEpisodes(); });

  // ========= ALL BOOKS =========
  let booksSorted = [...allBooksData];
  let bookPage = 1;
  let booksGenreFilter = 'all';

  function sortBooksBy(key) {
    const [f, d] = key.split('-');
    const dir = d === 'desc' ? -1 : 1;
    booksSorted.sort((a, b) => {
      if (f === 'count') return (a.count - b.count) * dir;
      if (f === 'rating') return ((a.rating||0) - (b.rating||0)) * dir;
      if (f === 'popularity') return ((a.num_ratings||0) - (b.num_ratings||0)) * dir;
      return (a[f]||'').toLowerCase().localeCompare((b[f]||'').toLowerCase()) * dir;
    });
  }

  function renderAllBooks() {
    const el = document.getElementById('books-tbody');
    const f = document.getElementById('book-search').value.toLowerCase();
    let filtered = booksSorted;
    if (booksGenreFilter !== 'all') filtered = filtered.filter(b => b.genre === booksGenreFilter);
    if (f) filtered = filtered.filter(b => (b.title + ' ' + b.author + ' ' + b.recommended_by.join(' ')).toLowerCase().includes(f));
    const toShow = filtered.slice(0, bookPage * 100);
    let html = '';
    toShow.forEach(b => {
      const bc = b.count >= 3 ? 'rec-badge hot' : 'rec-badge';
      const genre = b.genre || 'nonfiction';
      const rHtml = b.rating ? `<span class="rating-num">${b.rating}</span> ★<span class="rating-count">${fmtNum(b.num_ratings)}</span>` : '<span style="color:#ccc;">—</span>';
      html += `<tr><td><strong>${esc(b.title)}</strong></td><td style="color:#888;">${esc(b.author)}</td><td><span class="genre-badge ${genre}">${genre}</span></td><td style="color:#888;font-size:0.78rem;">${esc(b.recommended_by.join(', '))}</td><td><span class="${bc}">${b.count}</span></td><td>${rHtml}</td></tr>`;
    });
    el.innerHTML = html || '<tr><td colspan="6" style="color:#aaa;">No books match.</td></tr>';
    document.getElementById('book-load-more').style.display = toShow.length < filtered.length ? 'block' : 'none';
  }

  sortBooksBy('count-desc');
  renderAllBooks();
  createGenrePills('books-genre-pills', g => { booksGenreFilter = g; bookPage = 1; renderAllBooks(); });
  document.getElementById('book-search').addEventListener('input', () => { bookPage = 1; renderAllBooks(); });
  document.getElementById('book-load-more').addEventListener('click', () => { bookPage++; renderAllBooks(); });
  document.getElementById('book-sort').addEventListener('change', e => { sortBooksBy(e.target.value); bookPage = 1; renderAllBooks(); });

  // ========= GUESTS =========
  function renderGuests(filter) {
    const el = document.getElementById('guests-grid');
    const f = (filter || '').toLowerCase();
    const gMap = {};
    episodes.forEach(ep => ep.guests.split(',').forEach(g => {
      g = g.trim(); if (!g) return;
      if (!gMap[g]) gMap[g] = { name: g, episodes: [] };
      gMap[g].episodes.push(ep);
    }));
    const guests = Object.values(gMap).sort((a, b) => a.name.localeCompare(b.name));
    let html = '';
    guests.forEach(g => {
      if (f && !g.name.toLowerCase().includes(f)) return;
      const books = g.episodes.flatMap(ep => ep.books.map(b => {
        const genre = b.genre || 'nonfiction';
        const star = b.rating ? ` ★${b.rating}` : '';
        return `<span class="genre-badge ${genre}" style="font-size:0.65rem;padding:1px 5px;">${genre[0].toUpperCase()}</span> ${esc(b.title)}${star}`;
      }));
      html += `<div class="guest-card"><div class="guest-name">${esc(g.name)}</div><div class="guest-ep">${g.episodes.length} ep — ${g.episodes.map(ep => fmtDate(ep.date)).join(', ')}</div><div class="guest-books">${books.join(' · ')}</div></div>`;
    });
    el.innerHTML = html || '<p style="color:#aaa;">No guests match.</p>';
  }
  renderGuests();
  document.getElementById('guest-search').addEventListener('input', e => renderGuests(e.target.value));

  // ========= TABS =========
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById('section-' + tab.dataset.tab).classList.add('active');
      if (tab.dataset.tab === 'scatter' && !scatterDone) { setTimeout(renderScatter, 50); scatterDone = true; }
    });
  });
});

function fmtDate(s) { return new Date(s+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}); }
function esc(s) { const d = document.createElement('div'); d.textContent = s||''; return d.innerHTML; }
function fmtNum(n) { if (!n) return '0'; if (n>=1e6) return (n/1e6).toFixed(1)+'M'; if (n>=1e3) return (n/1e3).toFixed(1)+'K'; return n+''; }
</script>
</body>
</html>
